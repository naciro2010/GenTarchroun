name: Deploy static site to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-validate:
    name: Build and Validate Static Site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate HTML files
        run: |
          echo "ğŸ“ Validating HTML structure..."
          # Check if index.html exists
          if [ ! -f "index.html" ]; then
            echo "âŒ Error: index.html not found"
            exit 1
          fi

          # Check for basic HTML structure
          for file in index.html pages/*.html; do
            if [ -f "$file" ]; then
              echo "âœ… Checking $file"
              if ! grep -q "<html" "$file"; then
                echo "âŒ Error: $file is missing <html> tag"
                exit 1
              fi
            fi
          done
          echo "âœ… All HTML files validated successfully"

      - name: Check required files
        run: |
          echo "ğŸ“‹ Checking required files..."
          required_files=("index.html" "sitemap.xml" "robots.txt")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done
          echo "âœ… All required files present"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload static site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          # Exclude unnecessary files
          retention-days: 1

  deploy-static:
    name: Deploy to GitHub Pages
    needs: build-and-validate
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“ Site URL: ${{ steps.deployment.outputs.page_url }}"
